#!/bin/bash
# =====================================================
# AZURE DATABASES ONLY DEPLOYMENT
# Sistema de Gesti√≥n de Pr√°cticas Profesionales - UPeU
# =====================================================
# Este script despliega SOLO las bases de datos en Azure
# Ideal para usar con Azure for Students ($100/mes cr√©dito)
# Luego puedes conectarte desde local o desplegar app en Render

set -e  # Exit on error

# =====================================================
# CONFIGURATION
# =====================================================
RESOURCE_GROUP="rg-upeu-ppp-databases"
LOCATION="eastus"  # O "brazilsouth" si prefieres m√°s cerca
POSTGRES_SERVER="psql-upeu-ppp"
POSTGRES_DB="upeu_ppp_system"
POSTGRES_ADMIN="upeu_admin"
REDIS_NAME="redis-upeu-ppp"
COSMOS_ACCOUNT="cosmos-upeu-ppp"
KEYVAULT_NAME="kv-upeu-ppp-db"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =====================================================
# HELPER FUNCTIONS
# =====================================================
print_header() {
    echo -e "${CYAN}"
    echo "========================================"
    echo "$1"
    echo "========================================"
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# =====================================================
# BANNER
# =====================================================
clear
echo -e "${CYAN}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  AZURE DATABASES DEPLOYMENT - UPeU PPP System       ‚ïë
‚ïë  Desplegando: PostgreSQL + Redis + Cosmos DB        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# =====================================================
# 1. CHECK PREREQUISITES
# =====================================================
print_header "üîç Verificando Prerrequisitos"

# Check Azure CLI
if ! command -v az &> /dev/null; then
    print_error "Azure CLI no est√° instalado"
    echo ""
    echo "Instalar Azure CLI:"
    echo "  Windows: https://aka.ms/installazurecliwindows"
    echo "  Linux: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash"
    echo "  macOS: brew install azure-cli"
    exit 1
fi
print_success "Azure CLI instalado"

# Check if logged in
if ! az account show &> /dev/null; then
    print_warning "No est√°s autenticado en Azure"
    echo ""
    print_info "Iniciando login..."
    az login
fi

# Get account info
SUBSCRIPTION_ID=$(az account show --query id -o tsv)
SUBSCRIPTION_NAME=$(az account show --query name -o tsv)
ACCOUNT_TYPE=$(az account show --query user.type -o tsv)

print_success "Autenticaci√≥n verificada"
echo ""
echo -e "${CYAN}üìä Informaci√≥n de la cuenta:${NC}"
echo "  Nombre: $SUBSCRIPTION_NAME"
echo "  ID: $SUBSCRIPTION_ID"
echo "  Tipo: $ACCOUNT_TYPE"
echo ""

# Check if Azure for Students
IS_STUDENT=$(az account show --query "tags.studentSubscription" -o tsv 2>/dev/null || echo "false")

if [[ "$SUBSCRIPTION_NAME" == *"Azure for Students"* ]] || [[ "$IS_STUDENT" == "true" ]]; then
    print_success "‚ú® Cuenta Azure for Students detectada - ¬°$100 USD/mes de cr√©dito!"
    echo ""
else
    print_warning "No se detect√≥ Azure for Students"
    echo ""
    echo "Si tienes email .edu, obt√©n cr√©dito gratis:"
    echo "  üëâ https://azure.microsoft.com/es-es/free/students/"
    echo ""
    read -p "¬øContinuar de todas formas? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Deployment cancelado"
        exit 0
    fi
fi

# =====================================================
# 2. SHOW ESTIMATED COSTS
# =====================================================
print_header "üí∞ Costos Estimados Mensuales"

echo ""
echo "Configuraci√≥n propuesta (optimizada para Students):"
echo ""
echo -e "${CYAN}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
echo -e "${CYAN}‚îÇ 1. PostgreSQL Flexible Server (Burstable B1ms)     ‚îÇ${NC}"
echo "‚îÇ    - 1 vCore, 2GB RAM                              ‚îÇ"
echo "‚îÇ    - 32GB Storage                                  ‚îÇ"
echo "‚îÇ    - Backup 7 d√≠as                                 ‚îÇ"
echo -e "${GREEN}‚îÇ    Costo: ~$12-15/mes                              ‚îÇ${NC}"
echo -e "${CYAN}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"
echo -e "${CYAN}‚îÇ 2. Redis Cache (Basic C0)                          ‚îÇ${NC}"
echo "‚îÇ    - 250MB Memoria                                 ‚îÇ"
echo "‚îÇ    - SSL habilitado                                ‚îÇ"
echo -e "${GREEN}‚îÇ    Costo: ~$16/mes                                 ‚îÇ${NC}"
echo -e "${CYAN}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"
echo -e "${CYAN}‚îÇ 3. Cosmos DB Serverless (MongoDB API)              ‚îÇ${NC}"
echo "‚îÇ    - Pay-per-use                                   ‚îÇ"
echo "‚îÇ    - Auto-scaling                                  ‚îÇ"
echo -e "${GREEN}‚îÇ    Costo: ~$5-10/mes (uso moderado)                ‚îÇ${NC}"
echo -e "${CYAN}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"
echo -e "${CYAN}‚îÇ 4. Key Vault                                       ‚îÇ${NC}"
echo "‚îÇ    - Almacenamiento de secretos                    ‚îÇ"
echo -e "${GREEN}‚îÇ    Costo: ~$0.03/mes                               ‚îÇ${NC}"
echo -e "${CYAN}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
echo ""
echo -e "${GREEN}üíµ TOTAL ESTIMADO: ~$35-45/mes${NC}"
echo -e "${BLUE}üéì Con Azure for Students: GRATIS ($100 cr√©dito/mes)${NC}"
echo ""

read -p "¬øContinuar con el deployment? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_info "Deployment cancelado"
    exit 0
fi

# =====================================================
# 3. CREATE RESOURCE GROUP
# =====================================================
print_header "üì¶ Creando Resource Group"

if az group exists --name "$RESOURCE_GROUP" | grep -q "true"; then
    print_warning "Resource group '$RESOURCE_GROUP' ya existe"
    read -p "¬øUsar el existente? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Deployment cancelado. Cambia RESOURCE_GROUP en el script."
        exit 1
    fi
else
    print_info "Creando resource group en $LOCATION..."
    az group create \
        --name "$RESOURCE_GROUP" \
        --location "$LOCATION" \
        --output none
    print_success "Resource group creado: $RESOURCE_GROUP"
fi

# =====================================================
# 4. CREATE KEY VAULT (para guardar passwords)
# =====================================================
print_header "üîê Creando Key Vault"

if az keyvault show --name "$KEYVAULT_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
    print_warning "Key Vault ya existe"
else
    print_info "Creando Key Vault..."
    az keyvault create \
        --name "$KEYVAULT_NAME" \
        --resource-group "$RESOURCE_GROUP" \
        --location "$LOCATION" \
        --output none
    
    print_success "Key Vault creado: $KEYVAULT_NAME"
fi

# =====================================================
# 5. CREATE POSTGRESQL DATABASE
# =====================================================
print_header "üêò Creando PostgreSQL Flexible Server"

# Generate secure password
POSTGRES_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-25)

if az postgres flexible-server show --name "$POSTGRES_SERVER" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
    print_warning "PostgreSQL server ya existe"
    echo ""
    print_info "Recuperando informaci√≥n existente..."
    
    # Try to get password from Key Vault
    POSTGRES_PASSWORD=$(az keyvault secret show \
        --vault-name "$KEYVAULT_NAME" \
        --name "postgres-password" \
        --query value -o tsv 2>/dev/null || echo "")
    
    if [ -z "$POSTGRES_PASSWORD" ]; then
        print_warning "No se pudo recuperar la contrase√±a del Key Vault"
        read -s -p "Ingresa la contrase√±a de PostgreSQL (o presiona Enter para generar nueva): " INPUT_PASSWORD
        echo
        if [ -z "$INPUT_PASSWORD" ]; then
            POSTGRES_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-25)
            print_info "Nueva contrase√±a generada"
        else
            POSTGRES_PASSWORD="$INPUT_PASSWORD"
        fi
    fi
else
    print_info "Creando PostgreSQL Flexible Server (optimizado para Students)..."
    echo "‚è≥ Esto puede tomar 5-10 minutos, por favor espera..."
    
    az postgres flexible-server create \
        --name "$POSTGRES_SERVER" \
        --resource-group "$RESOURCE_GROUP" \
        --location "$LOCATION" \
        --admin-user "$POSTGRES_ADMIN" \
        --admin-password "$POSTGRES_PASSWORD" \
        --sku-name Standard_B1ms \
        --tier Burstable \
        --storage-size 32 \
        --version 15 \
        --public-access 0.0.0.0-255.255.255.255 \
        --backup-retention 7 \
        --output none
    
    print_success "PostgreSQL server creado: $POSTGRES_SERVER"
    
    # Store password in Key Vault
    print_info "Guardando contrase√±a en Key Vault..."
    az keyvault secret set \
        --vault-name "$KEYVAULT_NAME" \
        --name "postgres-password" \
        --value "$POSTGRES_PASSWORD" \
        --output none
    
    # Create database
    print_info "Creando base de datos '$POSTGRES_DB'..."
    az postgres flexible-server db create \
        --resource-group "$RESOURCE_GROUP" \
        --server-name "$POSTGRES_SERVER" \
        --database-name "$POSTGRES_DB" \
        --output none
    
    print_success "Base de datos '$POSTGRES_DB' creada"
    
    # Configure firewall rule for current IP
    print_info "Configurando reglas de firewall..."
    MY_IP=$(curl -s https://api.ipify.org)
    az postgres flexible-server firewall-rule create \
        --resource-group "$RESOURCE_GROUP" \
        --name "$POSTGRES_SERVER" \
        --rule-name "AllowMyIP" \
        --start-ip-address "$MY_IP" \
        --end-ip-address "$MY_IP" \
        --output none
    
    print_success "Firewall configurado para tu IP: $MY_IP"
fi

# =====================================================
# 6. CREATE REDIS CACHE
# =====================================================
print_header "üî¥ Creando Redis Cache"

if az redis show --name "$REDIS_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
    print_warning "Redis cache ya existe"
else
    print_info "Creando Redis cache (Basic C0 - optimizado para Students)..."
    echo "‚è≥ Esto puede tomar 10-15 minutos, por favor espera..."
    
    az redis create \
        --name "$REDIS_NAME" \
        --resource-group "$RESOURCE_GROUP" \
        --location "$LOCATION" \
        --sku Basic \
        --vm-size C0 \
        --enable-non-ssl-port false \
        --output none
    
    print_success "Redis cache creado: $REDIS_NAME"
fi

# Get Redis keys
print_info "Obteniendo claves de Redis..."
REDIS_KEY=$(az redis list-keys \
    --name "$REDIS_NAME" \
    --resource-group "$RESOURCE_GROUP" \
    --query primaryKey -o tsv)

# Store in Key Vault
az keyvault secret set \
    --vault-name "$KEYVAULT_NAME" \
    --name "redis-key" \
    --value "$REDIS_KEY" \
    --output none

print_success "Claves de Redis guardadas en Key Vault"

# =====================================================
# 7. CREATE COSMOS DB (MongoDB API)
# =====================================================
print_header "üåå Creando Cosmos DB (MongoDB API)"

if az cosmosdb show --name "$COSMOS_ACCOUNT" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
    print_warning "Cosmos DB account ya existe"
else
    print_info "Creando Cosmos DB Serverless (optimizado para Students)..."
    echo "‚è≥ Esto puede tomar 5-10 minutos, por favor espera..."
    
    az cosmosdb create \
        --name "$COSMOS_ACCOUNT" \
        --resource-group "$RESOURCE_GROUP" \
        --kind MongoDB \
        --server-version 6.0 \
        --default-consistency-level Session \
        --locations regionName="$LOCATION" failoverPriority=0 \
        --capabilities EnableServerless \
        --output none
    
    print_success "Cosmos DB account creado: $COSMOS_ACCOUNT"
    
    # Create database
    print_info "Creando base de datos 'upeu_documents'..."
    az cosmosdb mongodb database create \
        --account-name "$COSMOS_ACCOUNT" \
        --resource-group "$RESOURCE_GROUP" \
        --name upeu_documents \
        --output none
    
    print_success "Base de datos MongoDB creada"
fi

# Get Cosmos DB connection string
print_info "Obteniendo connection string de Cosmos DB..."
COSMOS_CONN=$(az cosmosdb keys list \
    --name "$COSMOS_ACCOUNT" \
    --resource-group "$RESOURCE_GROUP" \
    --type connection-strings \
    --query "connectionStrings[0].connectionString" -o tsv)

# Store in Key Vault
az keyvault secret set \
    --vault-name "$KEYVAULT_NAME" \
    --name "cosmos-connection-string" \
    --value "$COSMOS_CONN" \
    --output none

print_success "Connection string guardado en Key Vault"

# =====================================================
# 8. GENERATE CONNECTION STRINGS
# =====================================================
print_header "üîó Generando Connection Strings"

# PostgreSQL
POSTGRES_HOST="$POSTGRES_SERVER.postgres.database.azure.com"
POSTGRES_CONN="postgres://$POSTGRES_ADMIN:$POSTGRES_PASSWORD@$POSTGRES_HOST:5432/$POSTGRES_DB?sslmode=require"

# Redis
REDIS_HOST="$REDIS_NAME.redis.cache.windows.net"
REDIS_CONN="rediss://:$REDIS_KEY@$REDIS_HOST:6380/0"

# MongoDB/Cosmos
MONGO_CONN="$COSMOS_CONN"

print_success "Connection strings generados"

# =====================================================
# 9. CREATE .env FILE FOR LOCAL DEVELOPMENT
# =====================================================
print_header "üìù Creando archivo .env.azure"

ENV_FILE=".env.azure"

cat > "$ENV_FILE" << EOF
# =====================================================
# AZURE DATABASES CONNECTION - AUTO-GENERATED
# =====================================================
# Generado: $(date)
# Resource Group: $RESOURCE_GROUP
# Location: $LOCATION

# =====================================================
# POSTGRESQL
# =====================================================
DB_NAME=$POSTGRES_DB
DB_USER=$POSTGRES_ADMIN
DB_PASSWORD=$POSTGRES_PASSWORD
DB_HOST=$POSTGRES_HOST
DB_PORT=5432

# PostgreSQL Connection String (completo)
DATABASE_URL=$POSTGRES_CONN

# =====================================================
# REDIS CACHE
# =====================================================
REDIS_HOST=$REDIS_HOST
REDIS_PORT=6380
REDIS_PASSWORD=$REDIS_KEY
USE_REDIS_CACHE=True

# Redis Connection String (completo)
REDIS_URL=$REDIS_CONN

# =====================================================
# MONGODB (Cosmos DB)
# =====================================================
MONGODB_DB_NAME=upeu_documents

# MongoDB Connection String (completo)
MONGODB_URI=$MONGO_CONN

# =====================================================
# CELERY
# =====================================================
CELERY_BROKER_URL=$REDIS_CONN
CELERY_RESULT_BACKEND=$REDIS_CONN
CELERY_TASK_ALWAYS_EAGER=False

# =====================================================
# AZURE KEY VAULT
# =====================================================
AZURE_KEY_VAULT_NAME=$KEYVAULT_NAME
AZURE_KEY_VAULT_URI=https://$KEYVAULT_NAME.vault.azure.net/

# =====================================================
# DJANGO SETTINGS (ajustar seg√∫n necesites)
# =====================================================
DEBUG=True
SECRET_KEY=django-insecure-change-this-in-production
ALLOWED_HOSTS=localhost,127.0.0.1

# =====================================================
# NOTAS IMPORTANTES
# =====================================================
# 1. NO commitear este archivo a git (ya est√° en .gitignore)
# 2. Para producci√≥n, usar variables de entorno reales
# 3. Passwords almacenados en Azure Key Vault: $KEYVAULT_NAME
# 4. Conexi√≥n desde local requiere IP whitelisted en firewall

EOF

print_success "Archivo .env.azure creado"

# =====================================================
# 10. TEST CONNECTIONS
# =====================================================
print_header "üß™ Probando Conexiones"

# Test PostgreSQL
print_info "Probando PostgreSQL..."
if command -v psql &> /dev/null; then
    if psql "$POSTGRES_CONN" -c "SELECT version();" &> /dev/null; then
        print_success "PostgreSQL: ‚úÖ Conexi√≥n exitosa"
    else
        print_warning "PostgreSQL: ‚ö†Ô∏è  No se pudo conectar (verifica firewall)"
    fi
else
    print_info "PostgreSQL: psql no instalado, saltando test"
fi

# Test Redis
print_info "Probando Redis..."
if command -v redis-cli &> /dev/null; then
    if redis-cli -h "$REDIS_HOST" -p 6380 --tls -a "$REDIS_KEY" PING &> /dev/null; then
        print_success "Redis: ‚úÖ Conexi√≥n exitosa"
    else
        print_warning "Redis: ‚ö†Ô∏è  No se pudo conectar (verifica firewall)"
    fi
else
    print_info "Redis: redis-cli no instalado, saltando test"
fi

print_success "Tests de conexi√≥n completados"

# =====================================================
# 11. DEPLOYMENT SUMMARY
# =====================================================
print_header "üìä RESUMEN DEL DEPLOYMENT"

echo ""
echo -e "${GREEN}‚úÖ ¬°Deployment completado exitosamente!${NC}"
echo ""
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${CYAN}üì¶ RECURSOS CREADOS${NC}"
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo -e "${BLUE}Resource Group:${NC}"
echo "  üìÅ $RESOURCE_GROUP ($LOCATION)"
echo ""
echo -e "${BLUE}1. PostgreSQL Database:${NC}"
echo "  üêò Server: $POSTGRES_HOST"
echo "  üìä Database: $POSTGRES_DB"
echo "  üë§ Usuario: $POSTGRES_ADMIN"
echo "  üîë Password: $POSTGRES_PASSWORD"
echo ""
echo -e "${BLUE}2. Redis Cache:${NC}"
echo "  üî¥ Host: $REDIS_HOST"
echo "  üîå Port: 6380 (SSL)"
echo "  üîë Primary Key: ${REDIS_KEY:0:20}..."
echo ""
echo -e "${BLUE}3. Cosmos DB (MongoDB API):${NC}"
echo "  üåå Account: $COSMOS_ACCOUNT"
echo "  üìä Database: upeu_documents"
echo "  üîó Endpoint: $COSMOS_ACCOUNT.mongo.cosmos.azure.com"
echo ""
echo -e "${BLUE}4. Key Vault:${NC}"
echo "  üîê Name: $KEYVAULT_NAME"
echo "  üîó URI: https://$KEYVAULT_NAME.vault.azure.net/"
echo ""
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${CYAN}üí∞ COSTOS ESTIMADOS${NC}"
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo "  PostgreSQL (B1ms): ~\$15/mes"
echo "  Redis (C0):        ~\$16/mes"
echo "  Cosmos DB:         ~\$5-10/mes"
echo "  Key Vault:         ~\$0.03/mes"
echo "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo -e "${GREEN}  TOTAL:             ~\$36-41/mes${NC}"
echo ""
if [[ "$SUBSCRIPTION_NAME" == *"Azure for Students"* ]]; then
    echo -e "${GREEN}  üéì Con tu cr√©dito de \$100/mes: ¬°GRATIS!${NC}"
    echo -e "${GREEN}  üíµ Te sobran ~\$60/mes para otros recursos${NC}"
fi
echo ""
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${CYAN}üìù ARCHIVOS GENERADOS${NC}"
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo "  ‚úÖ $ENV_FILE"
echo "     Connection strings para desarrollo local"
echo ""
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${CYAN}üöÄ PR√ìXIMOS PASOS${NC}"
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo "1Ô∏è‚É£  Copiar configuraci√≥n para desarrollo local:"
echo "   ${YELLOW}cp $ENV_FILE .env${NC}"
echo ""
echo "2Ô∏è‚É£  Probar conexi√≥n desde Django:"
echo "   ${YELLOW}python manage.py check${NC}"
echo "   ${YELLOW}python manage.py migrate${NC}"
echo ""
echo "3Ô∏è‚É£  Cargar datos iniciales:"
echo "   ${YELLOW}python manage.py dbshell < docs/arquitectura/crear_bd_completa.sql${NC}"
echo ""
echo "4Ô∏è‚É£  Crear superusuario:"
echo "   ${YELLOW}python manage.py createsuperuser${NC}"
echo ""
echo "5Ô∏è‚É£  Desplegar aplicaci√≥n (opcional):"
echo "   ‚Ä¢ Local: ${YELLOW}python manage.py runserver${NC}"
echo "   ‚Ä¢ Render: Usar estas conexiones en variables de entorno"
echo "   ‚Ä¢ Azure App Service: Usar script deploy_azure.sh completo"
echo ""
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${CYAN}‚ö†Ô∏è  INFORMACI√ìN IMPORTANTE${NC}"
echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo "üîí Credenciales guardadas en:"
echo "   ‚Ä¢ Archivo local: ${YELLOW}$ENV_FILE${NC}"
echo "   ‚Ä¢ Azure Key Vault: ${YELLOW}$KEYVAULT_NAME${NC}"
echo ""
echo "üåê Acceso desde local:"
echo "   ‚Ä¢ Tu IP actual ($MY_IP) ya est√° whitelisted"
echo "   ‚Ä¢ Para otras IPs, agregar en Azure Portal ‚Üí Firewall rules"
echo ""
echo "üîó Gestionar recursos:"
echo "   ‚Ä¢ Portal: ${BLUE}https://portal.azure.com${NC}"
echo "   ‚Ä¢ Resource Group: Buscar '$RESOURCE_GROUP'"
echo ""
echo "üìä Monitorear costos:"
echo "   ‚Ä¢ Portal ‚Üí Cost Management + Billing"
echo "   ‚Ä¢ Alerts recomendados: \$50, \$75, \$90"
echo ""
echo -e "${GREEN}‚ú® ¬°Todo listo! Tus bases de datos est√°n en la nube.${NC}"
echo ""

# Save summary to file
SUMMARY_FILE="azure_databases_deployment_summary.txt"
{
    echo "AZURE DATABASES DEPLOYMENT SUMMARY"
    echo "Generated: $(date)"
    echo "=================================================="
    echo ""
    echo "PostgreSQL:"
    echo "  Connection: $POSTGRES_CONN"
    echo ""
    echo "Redis:"
    echo "  Connection: $REDIS_CONN"
    echo ""
    echo "MongoDB (Cosmos DB):"
    echo "  Connection: $MONGO_CONN"
    echo ""
    echo "Key Vault:"
    echo "  Name: $KEYVAULT_NAME"
    echo "  URI: https://$KEYVAULT_NAME.vault.azure.net/"
    echo ""
    echo "Resource Group: $RESOURCE_GROUP"
    echo "Location: $LOCATION"
} > "$SUMMARY_FILE"

print_success "Resumen guardado en: $SUMMARY_FILE"
echo ""
print_success "üéâ ¬°Deployment completado! üéâ"
